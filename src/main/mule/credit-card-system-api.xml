<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:http="http://www.mulesoft.org/schema/mule/http" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
      http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
      http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
	http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

  <!-- GET /cards - Business Logic Flow -->
  <flow name="get-cards-business-logic" doc:name="get-cards-business-logic">
    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB select par des données mockées -->
      <ee:transform doc:name="Mock Select Cards" doc:id="mock-select-cards">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/java
---
[
  {
    id: 1,
    card_number: "4532123456789012",
    card_type: "Credit",
    card_network: "Visa",
    customer_id: "550e8400-e29b-41d4-a716-446655440000",
    account_id: 1,
    cardholder_name: "Jean Dupont",
    expiration_date: "2025-12-31",
    status: "Active",
    credit_limit: 5000.00,
    available_credit: 4500.00,
    daily_purchase_limit: 1000.00,
    daily_atm_withdrawal_limit: 500.00,
    international_transactions_enabled: true,
    online_transactions_enabled: true,
    issued_date: "2024-01-01",
    created_at: "2024-01-01T10:00:00Z",
    updated_at: "2024-01-01T10:00:00Z"
  }
] default []]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <ee:transform doc:name="Transform to Card Response">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/json
---
payload map ((card) -> {
  id: card.id,
  cardNumber: card.card_number,
  cardType: card.card_type,
  cardNetwork: card.card_network,
  customerId: card.customer_id,
  accountId: card.account_id,
  cardholderName: card.cardholder_name,
  expirationDate: card.expiration_date,
  status: card.status,
  creditLimit: card.credit_limit,
  availableCredit: card.available_credit,
  controls: {
    dailyPurchaseLimit: card.daily_purchase_limit,
    dailyATMWithdrawalLimit: card.daily_atm_withdrawal_limit,
    internationalTransactionsEnabled: card.international_transactions_enabled,
    onlineTransactionsEnabled: card.online_transactions_enabled
  },
  issuedDate: card.issued_date,
  createdAt: card.created_at,
  updatedAt: card.updated_at
})]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <set-variable variableName="httpStatus" value="200" doc:name="Set Status 200" />

      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="500" doc:name="Set Status 500" />
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- POST /cards - Business Logic Flow -->
  <flow name="create-card-business-logic" doc:name="create-card-business-logic">
    <ee:transform doc:name="Transform Request to DB Format">
      <ee:message>
        <ee:set-payload>
          <![CDATA[%dw 2.0
output application/java
var controls = payload.controls default {}
---
{
  card_number: payload.cardNumber,
  card_type: payload.cardType,
  card_network: payload.cardNetwork default null,
  customer_id: payload.customerId,
  account_id: payload.accountId default null,
  cardholder_name: payload.cardholderName default null,
  expiration_date: payload.expirationDate default null,
  status: payload.status default 'Active',
  credit_limit: payload.creditLimit default null,
  available_credit: payload.availableCredit default payload.creditLimit default null,
  daily_purchase_limit: controls.dailyPurchaseLimit default null,
  daily_atm_withdrawal_limit: controls.dailyATMWithdrawalLimit default null,
  international_transactions_enabled: controls.internationalTransactionsEnabled default true,
  online_transactions_enabled: controls.onlineTransactionsEnabled default true,
  issued_date: payload.issuedDate default null
}]]>
        </ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB insert par des données mockées -->
      <ee:transform doc:name="Mock Insert Card" doc:id="mock-insert-card">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/java
var data = payload
---
[{
  id: 1,
  card_number: data.card_number,
  card_type: data.card_type,
  card_network: data.card_network,
  customer_id: data.customer_id,
  account_id: data.account_id,
  cardholder_name: data.cardholder_name,
  expiration_date: data.expiration_date,
  status: data.status,
  credit_limit: data.credit_limit,
  available_credit: data.available_credit,
  daily_purchase_limit: data.daily_purchase_limit,
  daily_atm_withdrawal_limit: data.daily_atm_withdrawal_limit,
  international_transactions_enabled: data.international_transactions_enabled,
  online_transactions_enabled: data.online_transactions_enabled,
  issued_date: data.issued_date,
  created_at: now(),
  updated_at: now()
}]]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <ee:transform doc:name="Transform Response">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/json
var card = payload[0]
---
{
  id: card.id,
  cardNumber: card.card_number,
  cardType: card.card_type,
  cardNetwork: card.card_network,
  customerId: card.customer_id,
  accountId: card.account_id,
  cardholderName: card.cardholder_name,
  expirationDate: card.expiration_date,
  status: card.status,
  creditLimit: card.credit_limit,
  availableCredit: card.available_credit,
  controls: {
    dailyPurchaseLimit: card.daily_purchase_limit,
    dailyATMWithdrawalLimit: card.daily_atm_withdrawal_limit,
    internationalTransactionsEnabled: card.international_transactions_enabled,
    onlineTransactionsEnabled: card.online_transactions_enabled
  },
  issuedDate: card.issued_date,
  createdAt: card.created_at,
  updatedAt: card.updated_at
}]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <set-variable variableName="httpStatus" value="201" doc:name="Set Status 201" />

      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while creating the card",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="500" doc:name="Set Status 500" />
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- GET /cards/{cardId} - Business Logic Flow -->
  <flow name="get-card-by-id-business-logic" doc:name="get-card-by-id-business-logic">
    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB select par des données mockées -->
      <ee:transform doc:name="Mock Select Card by ID" doc:id="mock-select-card-by-id">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/java
var cardId = vars.cardId default 1
---
[{
  id: cardId,
  card_number: "4532123456789012",
  card_type: "Credit",
  card_network: "Visa",
  customer_id: "550e8400-e29b-41d4-a716-446655440000",
  account_id: 1,
  cardholder_name: "Jean Dupont",
  expiration_date: "2025-12-31",
  status: "Active",
  credit_limit: 5000.00,
  available_credit: 4500.00,
  daily_purchase_limit: 1000.00,
  daily_atm_withdrawal_limit: 500.00,
  international_transactions_enabled: true,
  online_transactions_enabled: true,
  issued_date: "2024-01-01",
  created_at: "2024-01-01T10:00:00Z",
  updated_at: "2024-01-01T10:00:00Z"
}] default []]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <choice doc:name="Card Found?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
var card = payload[0]
---
{
  id: card.id,
  cardNumber: card.card_number,
  cardType: card.card_type,
  cardNetwork: card.card_network,
  customerId: card.customer_id,
  accountId: card.account_id,
  cardholderName: card.cardholder_name,
  expirationDate: card.expiration_date,
  status: card.status,
  creditLimit: card.credit_limit,
  availableCredit: card.available_credit,
  controls: {
    dailyPurchaseLimit: card.daily_purchase_limit,
    dailyATMWithdrawalLimit: card.daily_atm_withdrawal_limit,
    internationalTransactionsEnabled: card.international_transactions_enabled,
    onlineTransactionsEnabled: card.online_transactions_enabled
  },
  issuedDate: card.issued_date,
  createdAt: card.created_at,
  updatedAt: card.updated_at
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="200" doc:name="Set Status 200" />
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Card not found",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="404" doc:name="Set Status 404" />
        </otherwise>
      </choice>

      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="500" doc:name="Set Status 500" />
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- PUT /cards/{cardId} - Business Logic Flow -->
  <flow name="update-card-business-logic" doc:name="update-card-business-logic">
    <ee:transform doc:name="Transform Request to DB Format">
      <ee:message>
        <ee:set-payload>
          <![CDATA[%dw 2.0
output application/java
var controls = payload.controls default {}
---
{
  cardId: vars.cardId,
  card_number: payload.cardNumber default null,
  card_type: payload.cardType default null,
  card_network: payload.cardNetwork default null,
  customer_id: payload.customerId default null,
  account_id: payload.accountId default null,
  cardholder_name: payload.cardholderName default null,
  expiration_date: payload.expirationDate default null,
  status: payload.status default null,
  credit_limit: payload.creditLimit default null,
  available_credit: payload.availableCredit default null,
  daily_purchase_limit: controls.dailyPurchaseLimit default null,
  daily_atm_withdrawal_limit: controls.dailyATMWithdrawalLimit default null,
  international_transactions_enabled: controls.internationalTransactionsEnabled default null,
  online_transactions_enabled: controls.onlineTransactionsEnabled default null,
  issued_date: payload.issuedDate default null
}]]>
        </ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB update par des données mockées -->
      <ee:transform doc:name="Mock Update Card" doc:id="mock-update-card">
        <ee:message>
          <ee:set-payload>
            <![CDATA[%dw 2.0
output application/java
var data = payload
---
[{
  id: data.cardId,
  card_number: data.card_number default "4532123456789012",
  card_type: data.card_type default "Credit",
  card_network: data.card_network default "Visa",
  customer_id: data.customer_id default "550e8400-e29b-41d4-a716-446655440000",
  account_id: data.account_id default 1,
  cardholder_name: data.cardholder_name default "Jean Dupont",
  expiration_date: data.expiration_date default "2025-12-31",
  status: data.status default "Active",
  credit_limit: data.credit_limit default 5000.00,
  available_credit: data.available_credit default 4500.00,
  daily_purchase_limit: data.daily_purchase_limit default 1000.00,
  daily_atm_withdrawal_limit: data.daily_atm_withdrawal_limit default 500.00,
  international_transactions_enabled: data.international_transactions_enabled default true,
  online_transactions_enabled: data.online_transactions_enabled default true,
  issued_date: data.issued_date default "2024-01-01",
  created_at: "2024-01-01T10:00:00Z",
  updated_at: now()
}]]]>
          </ee:set-payload>
        </ee:message>
      </ee:transform>

      <choice doc:name="Update Successful?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
var card = payload[0]
---
{
  id: card.id,
  cardNumber: card.card_number,
  cardType: card.card_type,
  cardNetwork: card.card_network,
  customerId: card.customer_id,
  accountId: card.account_id,
  cardholderName: card.cardholder_name,
  expirationDate: card.expiration_date,
  status: card.status,
  creditLimit: card.credit_limit,
  availableCredit: card.available_credit,
  controls: {
    dailyPurchaseLimit: card.daily_purchase_limit,
    dailyATMWithdrawalLimit: card.daily_atm_withdrawal_limit,
    internationalTransactionsEnabled: card.international_transactions_enabled,
    onlineTransactionsEnabled: card.online_transactions_enabled
  },
  issuedDate: card.issued_date,
  createdAt: card.created_at,
  updatedAt: card.updated_at
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="200" doc:name="Set Status 200" />
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Card not found",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="404" doc:name="Set Status 404" />
        </otherwise>
      </choice>

      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload>
                <![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while updating the card",
    timestamp: now()
  }
}]]>
              </ee:set-payload>
            </ee:message>
          </ee:transform>
          <set-variable variableName="httpStatus" value="500" doc:name="Set Status 500" />
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

</mule>